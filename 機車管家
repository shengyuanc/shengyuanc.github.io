import React, { useState, useEffect, useMemo } from 'react';
import { Plus, Fuel, Wrench, Trash2, History, TrendingUp, Wallet, Bike, LogOut, User as UserIcon, Loader2 } from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged,
  signOut,
  GoogleAuthProvider,
  signInWithPopup
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  doc, 
  onSnapshot 
} from 'firebase/firestore';

// --- Firebase Configuration (User Provided) ---
const firebaseConfig = {
  apiKey: "AIzaSyAXJAAnQcYTL6nONk5dUpA10rtbcoVLj58",
  authDomain: "scooter-butler.firebaseapp.com",
  projectId: "scooter-butler",
  storageBucket: "scooter-butler.firebasestorage.app",
  messagingSenderId: "233266139784",
  appId: "1:233266139784:web:b3b961b231413a6e7a453d",
  measurementId: "G-CRV6J2NB05"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

const MotoKeeper = () => {
  // --- State Management ---
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  
  const [activeTab, setActiveTab] = useState('dashboard'); // dashboard, add, history
  const [recordType, setRecordType] = useState('fuel'); // fuel, maintenance
  
  // Data state (Fetched from Firestore)
  const [records, setRecords] = useState([]);
  const [dataLoading, setDataLoading] = useState(false);

  // Form States
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [odometer, setOdometer] = useState('');
  const [cost, setCost] = useState('');
  const [notes, setNotes] = useState('');
  
  // Fuel specific
  const [liters, setLiters] = useState('');
  const [pricePerLiter, setPricePerLiter] = useState('');

  // Maintenance specific
  const [item, setItem] = useState('');

  // --- Firebase Auth & Data Logic ---

  // 1. Listen for Auth State Changes
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. Fetch Data (Real-time Listener)
  useEffect(() => {
    if (!user) {
      setRecords([]);
      return;
    }

    setDataLoading(true);
    // Path: users/{userId}/records (Standard path for personal project)
    const recordsRef = collection(db, 'users', user.uid, 'records');

    const unsubscribe = onSnapshot(recordsRef, 
      (snapshot) => {
        const fetchedRecords = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setRecords(fetchedRecords);
        setDataLoading(false);
      },
      (error) => {
        console.error("Data Fetch Error:", error);
        if (error.code === 'permission-denied') {
          alert("讀取資料失敗：權限不足。\n請檢查 Firebase Console > Firestore Database > Rules，確保規則允許讀寫 (test mode)。");
        }
        setDataLoading(false);
      }
    );

    return () => unsubscribe();
  }, [user]);

  // --- Handlers ---

  const handleGoogleLogin = async () => {
    try {
      await signInWithPopup(auth, googleProvider);
    } catch (error) {
      console.error("Login Failed:", error);
      if (error.code === 'auth/unauthorized-domain') {
        alert(`網域未授權錯誤 (Unauthorized Domain)\n\n請至 Firebase Console > Authentication > Settings > Authorized Domains 將您的網址加入白名單。`);
      } else {
        alert("登入失敗: " + error.message);
      }
    }
  };

  const handleLogout = async () => {
    if(window.confirm("確定要登出嗎？")) {
      await signOut(auth);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;
    
    const newRecord = {
      type: recordType,
      date,
      odometer: parseFloat(odometer),
      cost: parseFloat(cost),
      notes,
      createdAt: Date.now(),
      // Fuel specifics
      ...(recordType === 'fuel' && {
        liters: parseFloat(liters),
        pricePerLiter: parseFloat(pricePerLiter)
      }),
      // Maintenance specifics
      ...(recordType === 'maintenance' && {
        item: item || '一般保養'
      })
    };

    try {
      await addDoc(collection(db, 'users', user.uid, 'records'), newRecord);
      resetForm();
      setActiveTab('history'); 
    } catch (error) {
      console.error("Error adding document: ", error);
      if (error.code === 'permission-denied') {
        alert("儲存失敗：權限不足。\n請至 Firebase Console 檢查 Firestore Rules 是否設定為測試模式 (allow read, write: if true;)");
      } else {
        alert("儲存失敗，請檢查網路連線");
      }
    }
  };

  const deleteRecord = async (id) => {
    if(window.confirm('確定要刪除這筆紀錄嗎？')) {
      try {
        await deleteDoc(doc(db, 'users', user.uid, 'records', id));
      } catch (error) {
        console.error("Error removing document: ", error);
        alert("刪除失敗");
      }
    }
  };

  const resetForm = () => {
    setOdometer('');
    setCost('');
    setNotes('');
    setLiters('');
    setPricePerLiter('');
    setItem('');
  };

  // Auto-calculate total cost for fuel
  useEffect(() => {
    if (recordType === 'fuel' && liters && pricePerLiter) {
      setCost((parseFloat(liters) * parseFloat(pricePerLiter)).toFixed(0));
    }
  }, [liters, pricePerLiter, recordType]);

  // --- Statistics Calculation (Memoized) ---
  const stats = useMemo(() => {
    if (records.length === 0) {
      return { totalCost: 0, totalDist: 0, costPerKm: 0, avgFuel: 0, fuelCost: 0, maintCost: 0 };
    }

    const sortedRecords = [...records].sort((a, b) => a.odometer - b.odometer);
    
    const minOdo = sortedRecords[0].odometer;
    const maxOdo = sortedRecords[sortedRecords.length - 1].odometer;
    const totalDist = maxOdo - minOdo;

    let fuelCost = 0;
    let maintCost = 0;
    let totalLiters = 0;

    sortedRecords.forEach(r => {
      if (r.type === 'fuel') {
        fuelCost += parseFloat(r.cost);
        totalLiters += parseFloat(r.liters || 0);
      } else {
        maintCost += parseFloat(r.cost);
      }
    });

    const totalCost = fuelCost + maintCost;
    const costPerKm = totalDist > 0 ? (totalCost / totalDist).toFixed(2) : 0;
    const avgFuel = totalLiters > 0 && totalDist > 0 ? (totalDist / totalLiters).toFixed(1) : 0;

    return {
      totalCost,
      totalDist,
      costPerKm,
      avgFuel,
      fuelCost,
      maintCost
    };
  }, [records]);

  // --- Components ---

  const StatCard = ({ title, value, unit, icon: Icon, colorClass }) => (
    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
      <div>
        <p className="text-gray-500 text-xs font-medium mb-1">{title}</p>
        <div className="flex items-baseline">
          <span className={`text-2xl font-bold ${colorClass}`}>{value}</span>
          <span className="text-gray-400 text-sm ml-1">{unit}</span>
        </div>
      </div>
      <div className={`p-3 rounded-full opacity-10 ${colorClass.replace('text', 'bg')}`}>
        <Icon size={24} className={colorClass} />
      </div>
    </div>
  );

  // --- Render Auth Loading ---
  if (authLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-400">
        <div className="flex flex-col items-center gap-2">
          <Loader2 className="animate-spin" size={32} />
          <p className="text-sm">載入中...</p>
        </div>
      </div>
    );
  }

  // --- Render Login Screen (If not logged in) ---
  if (!user) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
        <div className="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center">
          <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-400">
            <Bike size={32} />
          </div>
          <h1 className="text-2xl font-bold text-gray-800 mb-2">機車管家</h1>
          <p className="text-gray-500 mb-8 text-sm">請登入以同步您的維修與加油紀錄</p>
          
          <div className="space-y-3">
            <button 
              onClick={handleGoogleLogin}
              className="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-all shadow-sm"
            >
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
              </svg>
              使用 Google 登入
            </button>
          </div>
        </div>
      </div>
    );
  }

  // --- Main App (If logged in) ---
  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 pb-20 md:pb-0">
      {/* Header */}
      <header className="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-10">
        <div className="max-w-md mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Bike className="text-yellow-400" />
            <h1 className="text-lg font-bold tracking-wide">機車管家</h1>
          </div>
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2">
              {user?.photoURL ? (
                <img src={user.photoURL} alt="User" className="w-6 h-6 rounded-full border border-slate-600" />
              ) : (
                <UserIcon size={16} className="text-slate-400" />
              )}
              <span className="text-xs text-slate-300 hidden sm:inline-block">
                {user.displayName}
              </span>
            </div>
            <button onClick={handleLogout} className="text-slate-400 hover:text-white transition-colors">
              <LogOut size={18} />
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4 space-y-6">

        {/* --- DASHBOARD VIEW --- */}
        {activeTab === 'dashboard' && (
          <div className="space-y-4 animate-fade-in">
            {/* Main Stats Grid */}
            <div className="grid grid-cols-2 gap-3">
              <StatCard 
                title="每公里成本" 
                value={stats.costPerKm} 
                unit="元" 
                icon={Wallet} 
                colorClass="text-emerald-600" 
              />
              <StatCard 
                title="平均油耗" 
                value={stats.avgFuel} 
                unit="km/L" 
                icon={TrendingUp} 
                colorClass="text-blue-600" 
              />
              <StatCard 
                title="總行駛里程" 
                value={stats.totalDist.toLocaleString()} 
                unit="km" 
                icon={Bike} 
                colorClass="text-slate-600" 
              />
               <StatCard 
                title="累計總花費" 
                value={stats.totalCost.toLocaleString()} 
                unit="元" 
                icon={Wallet} 
                colorClass="text-rose-600" 
              />
            </div>

            {/* Cost Breakdown Bar */}
            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
              <h3 className="text-gray-700 font-bold mb-4 text-sm">花費比例分析</h3>
              <div className="flex h-6 w-full rounded-full overflow-hidden bg-gray-100 mb-2">
                <div 
                  className="bg-blue-500 h-full transition-all duration-500" 
                  style={{ width: `${stats.totalCost > 0 ? (stats.fuelCost / stats.totalCost) * 100 : 0}%` }}
                ></div>
                <div 
                  className="bg-amber-500 h-full transition-all duration-500" 
                  style={{ width: `${stats.totalCost > 0 ? (stats.maintCost / stats.totalCost) * 100 : 0}%` }}
                ></div>
              </div>
              <div className="flex justify-between text-xs text-gray-500 mt-2">
                <div className="flex items-center gap-1">
                  <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                  <span>油錢 ${stats.fuelCost.toLocaleString()}</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                  <span>維修保養 ${stats.maintCost.toLocaleString()}</span>
                </div>
              </div>
            </div>

             {/* Tip Card */}
             <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-sm text-indigo-800">
                <p className="font-bold mb-1">☁️ 雲端同步中</p>
                <p>資料將儲存在您的私人資料庫中。</p>
             </div>
          </div>
        )}

        {/* --- ADD RECORD VIEW --- */}
        {activeTab === 'add' && (
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
            {/* Type Toggle */}
            <div className="flex border-b border-gray-100">
              <button 
                onClick={() => setRecordType('fuel')}
                className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${recordType === 'fuel' ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}
              >
                <Fuel size={18} /> 加油紀錄
              </button>
              <button 
                onClick={() => setRecordType('maintenance')}
                className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 transition-colors ${recordType === 'maintenance' ? 'text-amber-600 bg-amber-50' : 'text-gray-400'}`}
              >
                <Wrench size={18} /> 維修保養
              </button>
            </div>

            <form onSubmit={handleSubmit} className="p-5 space-y-4">
              {/* Common Fields */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-gray-500 mb-1">日期</label>
                  <input 
                    type="date" 
                    required
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                    className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-500 mb-1">目前里程 (km)</label>
                  <input 
                    type="number" 
                    required
                    placeholder="例如: 15000"
                    value={odometer}
                    onChange={(e) => setOdometer(e.target.value)}
                    className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Fuel Specific Fields */}
              {recordType === 'fuel' && (
                <>
                  <div className="grid grid-cols-2 gap-4">
                     <div>
                      <label className="block text-xs text-gray-500 mb-1">油價 (元/L)</label>
                      <input 
                        type="number" 
                        step="0.1"
                        placeholder="30.5"
                        value={pricePerLiter}
                        onChange={(e) => setPricePerLiter(e.target.value)}
                        className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">公升數 (L)</label>
                      <input 
                        type="number" 
                        step="0.01"
                        placeholder="5.20"
                        value={liters}
                        onChange={(e) => setLiters(e.target.value)}
                        className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                </>
              )}

              {/* Maintenance Specific Fields */}
              {recordType === 'maintenance' && (
                <div>
                  <label className="block text-xs text-gray-500 mb-1">保養項目</label>
                  <input 
                    type="text" 
                    placeholder="例如: 機油、輪胎、煞車皮"
                    value={item}
                    onChange={(e) => setItem(e.target.value)}
                    className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                  />
                </div>
              )}

              {/* Cost & Notes */}
              <div>
                <label className="block text-xs text-gray-500 mb-1">總金額 (元)</label>
                <div className="relative">
                  <span className="absolute left-3 top-2 text-gray-400">$</span>
                  <input 
                    type="number" 
                    required
                    value={cost}
                    onChange={(e) => setCost(e.target.value)}
                    className="w-full p-2 pl-7 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 font-bold text-gray-700"
                  />
                </div>
              </div>

              <div>
                <label className="block text-xs text-gray-500 mb-1">備註 (選填)</label>
                <textarea 
                  rows="2"
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 text-sm"
                ></textarea>
              </div>

              <button 
                type="submit" 
                className={`w-full py-3 rounded-xl text-white font-bold shadow-md transform transition active:scale-95 ${recordType === 'fuel' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-amber-600 hover:bg-amber-700'}`}
              >
                儲存紀錄
              </button>
            </form>
          </div>
        )}

        {/* --- HISTORY VIEW --- */}
        {activeTab === 'history' && (
          <div className="space-y-3 animate-fade-in">
             <div className="flex justify-between items-center mb-2">
                <h3 className="font-bold text-gray-700">歷史紀錄 ({records.length})</h3>
                {dataLoading && <Loader2 size={16} className="animate-spin text-gray-400"/>}
             </div>
            
            {dataLoading && records.length === 0 ? (
              <div className="text-center py-10 text-gray-400">
                 <Loader2 size={24} className="animate-spin mx-auto mb-2"/>
                 <p>讀取資料中...</p>
              </div>
            ) : records.length === 0 ? (
              <div className="text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">
                <p>目前還沒有紀錄喔</p>
                <p className="text-xs mt-1">點擊下方「+」按鈕開始紀錄</p>
              </div>
            ) : (
              [...records].sort((a, b) => b.odometer - a.odometer).map((record) => (
                <div key={record.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                  <div className="flex gap-3 items-center">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${record.type === 'fuel' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600'}`}>
                      {record.type === 'fuel' ? <Fuel size={18} /> : <Wrench size={18} />}
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="font-bold text-gray-800">
                          {record.type === 'fuel' ? '加油' : record.item}
                        </span>
                        <span className="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">
                          {record.odometer.toLocaleString()} km
                        </span>
                      </div>
                      <div className="text-xs text-gray-400 mt-1">
                        {record.date} 
                        {record.type === 'fuel' && ` • ${record.liters}L @ ${record.pricePerLiter}/L`}
                        {record.notes && ` • ${record.notes}`}
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-2">
                    <span className="font-bold text-gray-700">${record.cost}</span>
                    <button 
                      onClick={() => deleteRecord(record.id)}
                      className="text-gray-300 hover:text-red-500 transition-colors"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        )}

      </main>

      {/* Navigation Bar (Mobile Style) */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around p-2 pb-safe shadow-[0_-5px_10px_rgba(0,0,0,0.02)] z-50">
        <NavButton 
          active={activeTab === 'dashboard'} 
          onClick={() => setActiveTab('dashboard')} 
          icon={TrendingUp} 
          label="總覽" 
        />
        <div className="relative -top-6">
          <button 
            onClick={() => { setActiveTab('add'); resetForm(); }}
            className="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center text-white shadow-lg shadow-slate-300 transform transition active:scale-90 hover:bg-slate-700"
          >
            <Plus size={28} strokeWidth={3} />
          </button>
        </div>
        <NavButton 
          active={activeTab === 'history'} 
          onClick={() => setActiveTab('history')} 
          icon={History} 
          label="紀錄" 
        />
      </nav>
    </div>
  );
};

const NavButton = ({ active, onClick, icon: Icon, label }) => (
  <button 
    onClick={onClick}
    className={`flex flex-col items-center justify-center w-16 h-12 gap-1 transition-colors ${active ? 'text-slate-800' : 'text-gray-400'}`}
  >
    <Icon size={20} strokeWidth={active ? 2.5 : 2} />
    <span className="text-[10px] font-medium">{label}</span>
  </button>
);

export default MotoKeeper;
