<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS ç›´æ’­æŠ½çå™¨ - ç°¡ç´„ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å¯æ„›åœ“é«”å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        /* è¨­å®šä¸»è¦å­—é«”ç‚ºåœ“é«” */
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            overflow: hidden; 
            background-color: transparent; /* OBS é€æ˜èƒŒæ™¯ */
        }
        
        .font-pop {
            font-family: 'Mochiy Pop One', sans-serif;
        }

        /* ä¸»å®¹å™¨å¤–æ¡†æ¨£å¼ - æ›´åŠ ç©©é‡çš„æ¡† */
        .main-frame {
            background: #fff0f5; 
            border: 6px solid #ffffff; 
            outline: 6px solid #f9a8d4; 
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* å…§éƒ¨é¢æ¿æ¨£å¼ */
        .inner-panel {
            background: rgba(255, 255, 255, 0.9); 
            border: 2px solid #fbcfe8;
            border-radius: 16px;
        }

        /* æ¼¸å±¤æ–‡å­— */
        .gradient-text {
            color: #db2777; 
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #f9a8d4; border-radius: 10px; }

        /* ç°¡åŒ–å¾Œçš„é«˜äº®æ•ˆæœï¼šåªæœ‰é‚Šæ¡†é¡è‰²è®ŠåŒ– */
        .new-winner-card {
            border: 2px solid #ec4899 !important;
            background: #fff1f2 !important;
        }

        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .winner-card {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="w-screen h-screen flex flex-col items-center justify-center p-4">

    <!-- ä¸»è¦å®¹å™¨ -->
    <div id="main-container" class="w-full max-w-6xl h-[650px] relative main-frame p-6 flex flex-col">
        
        <!-- é€£ç·šç‹€æ…‹ç‡ˆ -->
        <div class="absolute top-6 right-6 flex items-center gap-2 bg-white px-3 py-1 rounded-full text-xs text-pink-500 border border-pink-200 font-bold z-50">
            <span id="status-dot" class="w-2 h-2 rounded-full bg-red-400"></span>
            <span id="status-text">é€£ç·šä¸­...</span>
        </div>

        <!-- æ¨™é¡Œå€ -->
        <div class="text-center mb-4 relative shrink-0">
            <h1 id="lottery-title" class="font-pop text-4xl text-pink-600 tracking-wider">
                è®€å–ä¸­...
            </h1>
            <div class="mt-2 inline-block bg-white border border-pink-200 px-4 py-1 rounded-full text-gray-600 font-bold text-sm">
                åƒèˆ‡ï¼š<span id="candidate-count" class="text-pink-500 mx-1">0</span> 
                <span class="text-gray-300 mx-1">|</span>
                æŠ½å‡ºï¼š<span id="draw-count" class="text-blue-500 mx-1">0</span> äºº
            </div>
        </div>

        <div class="grid grid-cols-12 gap-4 flex-1 overflow-hidden">
            
            <!-- å·¦å´ï¼šæ–çå€ (4ç­‰ä»½) -->
            <div class="col-span-4 h-full flex flex-col">
                <div id="lottery-box" class="inner-panel w-full flex-1 flex flex-col items-center justify-center relative overflow-hidden bg-white shadow-sm">
                    
                    <!-- é¡¯ç¤ºå€åŸŸæ¨™é¡Œ -->
                    <div class="absolute top-3 text-pink-300 font-bold text-base font-pop">
                        æ­£åœ¨æŠ½å‡º...
                    </div>

                    <!-- æ»¾å‹•åå­—é¡¯ç¤ºå€ -->
                    <div id="display-area" class="w-full text-center px-2 relative z-20 h-32 flex items-center justify-center">
                        <div class="text-gray-400 text-xl font-bold font-pop">
                            æº–å‚™ä¸­
                        </div>
                    </div>

                    <!-- é€²åº¦æ¢ -->
                    <div id="progress-container" class="absolute bottom-0 left-0 w-full h-2 bg-gray-100">
                        <div id="progress-bar" class="h-full bg-pink-400 w-0 transition-all duration-100"></div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šçµæœåå–® (8ç­‰ä»½) -->
            <div class="col-span-8 h-full">
                <div class="inner-panel w-full h-full p-4 flex flex-col bg-white shadow-sm overflow-hidden">
                    <div class="flex justify-between items-center mb-2 border-b border-pink-100 pb-2 shrink-0">
                        <h2 class="text-pink-500 text-xl font-black flex items-center gap-2 font-pop">
                            ğŸ‘‘ ä¸­çåå–®
                        </h2>
                        <!-- ç‹€æ…‹æç¤º -->
                        <span id="drawing-status" class="text-xs text-purple-400 font-bold opacity-0 transition-opacity duration-300">æ­£åœ¨é–‹ç...</span>
                    </div>
                    
                    <!-- åˆ—è¡¨å€åŸŸ -->
                    <div id="winners-list" class="flex-1 overflow-y-auto custom-scrollbar grid grid-cols-1 gap-2 content-start pr-1">
                        <!-- é€™è£¡æœƒå‹•æ…‹æ’å…¥ä¸­çè€… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç´™èŠ±ç‰¹æ•ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // ==========================================
        // æ‚¨çš„è©¦ç®—è¡¨ ID
        // ==========================================
        const GOOGLE_SHEET_ID = "113U5VEc7YPP4kv8o5Ek_rBNd4aVlSM1-mRE07XA0Yrg"; 
        // ==========================================

        let isRolling = false;
        let lastCheckboxState = false;
        let allCandidates = [];
        let pastWinners = new Set();
        let config = { title: '', drawCount: 1 };
        let pollInterval = null;

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        window.onload = () => { startPolling(); };

        function startPolling() {
            updateStatus('connecting', 'é€£ç·šä¸­...');
            fetchData();
            pollInterval = setInterval(fetchData, 2000); 
        }

        // ==========================================
        // ä¿®æ”¹é‡é»ï¼šæ”¹ç”¨ JSONP æ–¹å¼è®€å–è³‡æ–™
        // é€™å¯ä»¥è§£æ±º CORS è·¨åŸŸéŒ¯èª¤
        // ==========================================
        
        // 1. å®šç¾©ä¸€å€‹å…¨åŸŸå‡½æ•¸ä¾†æ¥æ”¶ Google çš„å›å‚³è³‡æ–™
        window.handleGoogleSheetData = function(json) {
            if (!json || !json.table) {
                updateStatus('error', 'æ ¼å¼éŒ¯èª¤');
                return;
            }
            processData(json.table);
            updateStatus('ok', 'OK');
        };

        // 2. å»ºç«‹ Script æ¨™ç±¤ä¾†ç™¼é€è«‹æ±‚
        function fetchData() {
            // ç§»é™¤èˆŠçš„ script æ¨™ç±¤ (é¿å…å †ç©)
            const oldScript = document.getElementById('gviz_script');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'gviz_script';
            // é—œéµåƒæ•¸ï¼štqx=responseHandler:window.handleGoogleSheetData
            // é€™å‘Šè¨´ Google ä¸è¦å›å‚³ç´”æ–‡å­—ï¼Œè€Œæ˜¯å›å‚³ä¸€æ®µåŸ·è¡Œæˆ‘å€‘å‡½æ•¸çš„ JavaScript ä»£ç¢¼
            script.src = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=responseHandler:window.handleGoogleSheetData`;
            
            script.onerror = function() {
                updateStatus('error', 'é€£ç·šå¤±æ•—');
                console.error('Script load error. è«‹æª¢æŸ¥è©¦ç®—è¡¨æ¬Šé™æ˜¯å¦å…¬é–‹ã€‚');
            };

            document.body.appendChild(script);
        }

        // è™•ç†è³‡æ–™ (é‚è¼¯ä¸è®Š)
        function processData(tableData) {
            const rows = tableData.rows;
            if (!rows || rows.length === 0) return;

            const configRow = rows[0];
            const newTitle = getValue(configRow, 4) || 'å¿«æ¨‚æŠ½ç'; 
            const newDrawCount = parseInt(getValue(configRow, 3)) || 1; 
            const triggerRaw = getValue(configRow, 2); 
            const newTrigger = (triggerRaw === true || triggerRaw === 'TRUE' || triggerRaw === 'true');

            if (config.title !== newTitle) {
                config.title = newTitle;
                document.getElementById('lottery-title').innerText = newTitle;
            }
            if (config.drawCount !== newDrawCount) {
                config.drawCount = newDrawCount;
                document.getElementById('draw-count').innerText = newDrawCount;
            }

            const candidates = [];
            rows.forEach(row => {
                const name = getValue(row, 0);
                const tickets = parseInt(getValue(row, 1)) || 1; 
                if (name) candidates.push({ name, tickets });
            });
            
            allCandidates = candidates;
            document.getElementById('candidate-count').innerText = allCandidates.length;

            if (newTrigger === true && lastCheckboxState === false) {
                if (!isRolling) startLottery();
            }
            else if (newTrigger === false && lastCheckboxState === true) {
                pastWinners.clear();
                updateWinnersList(); 
                resetDisplay();
            }
            lastCheckboxState = newTrigger;
        }

        function getValue(row, index) {
            return (row.c[index] && row.c[index].v !== null) ? row.c[index].v : null;
        }

        function getSmartFontSize(textLength) {
            if (textLength <= 2) return 'text-5xl';
            if (textLength <= 4) return 'text-4xl';
            if (textLength <= 6) return 'text-3xl';
            return 'text-2xl';
        }

        function checkGridColumns() {
            const listEl = document.getElementById('winners-list');
            if (pastWinners.size > 5) {
                listEl.classList.remove('grid-cols-1');
                listEl.classList.add('grid-cols-2');
            } else {
                listEl.classList.add('grid-cols-1');
                listEl.classList.remove('grid-cols-2');
            }
        }

        async function startLottery() {
            const available = allCandidates.filter(c => !pastWinners.has(c.name));
            if (available.length === 0) return;

            isRolling = true;
            document.getElementById('drawing-status').style.opacity = '1'; 
            
            let pool = [];
            available.forEach(c => {
                for(let i=0; i<c.tickets; i++) pool.push(c.name);
            });

            const currentWinners = [];
            let tempPool = [...pool];
            for (let i = 0; i < config.drawCount; i++) {
                if (tempPool.length === 0) break;
                const idx = Math.floor(Math.random() * tempPool.length);
                const winner = tempPool[idx];
                currentWinners.push(winner);
                tempPool = tempPool.filter(n => n !== winner);
            }

            await runRollingAnimation(pool, 3000);
            await revealWinnersSequence(currentWinners, pool);

            isRolling = false;
            document.getElementById('drawing-status').style.opacity = '0';
            document.getElementById('display-area').innerHTML = `
                <div class="text-pink-500 text-xl font-bold font-pop">
                    é–‹çå®Œæˆ
                </div>
            `;
            document.getElementById('progress-bar').style.width = '100%';
        }

        function runRollingAnimation(pool, duration) {
            return new Promise(resolve => {
                const displayEl = document.getElementById('display-area');
                const progressBar = document.getElementById('progress-bar');
                let start = Date.now();

                const animate = () => {
                    let now = Date.now();
                    let progress = (now - start) / duration;

                    if (progress < 1) {
                        const randomName = pool[Math.floor(Math.random() * pool.length)];
                        const sizeClass = getSmartFontSize(randomName ? randomName.length : 2);
                        
                        displayEl.innerHTML = `
                            <div class="${sizeClass} font-black text-pink-400 font-pop">
                                ${randomName}
                            </div>
                        `;
                        progressBar.style.width = `${progress * 80}%`; 
                        requestAnimationFrame(animate);
                    } else {
                        resolve();
                    }
                };
                animate();
            });
        }

        async function revealWinnersSequence(winners, pool) {
            const displayEl = document.getElementById('display-area');

            for (let i = 0; i < winners.length; i++) {
                const winner = winners[i];
                if (i > 0) await runRollingAnimation(pool, 500);

                const sizeClass = getSmartFontSize(winner.length);
                displayEl.innerHTML = `
                    <div class="${sizeClass} font-black text-purple-600 font-pop drop-shadow-sm">
                        ${winner}
                    </div>
                `;

                confetti({ 
                    particleCount: 80, 
                    spread: 50, 
                    origin: { x: 0.3, y: 0.6 },
                    colors: ['#f472b6', '#c084fc', '#facc15']
                });

                pastWinners.add(winner);
                addWinnerToDom(winner, true);

                await delay(1500);
                removeHighlight();
            }
        }

        function addWinnerToDom(name, isNew = false) {
            const listEl = document.getElementById('winners-list');
            const rank = pastWinners.size; 
            
            checkGridColumns();

            const div = document.createElement('div');
            const bgClass = isNew ? 'new-winner-card' : 'bg-gray-50';
            const borderClass = isNew ? '' : 'border-gray-100';
            
            div.className = `winner-card ${bgClass} p-2 rounded-lg border ${borderClass} flex justify-between items-center animate__animated animate__fadeIn shadow-sm`;
            
            // ç§»é™¤ NEW æ¨™ç±¤ï¼Œä¿ç•™æ•¸å­—å’Œå§“å
            div.innerHTML = `
                <div class="flex items-center gap-2 overflow-hidden w-full">
                    <div class="w-6 h-6 rounded-full bg-pink-400 text-white flex items-center justify-center font-bold text-xs shrink-0">
                        ${rank}
                    </div>
                    <span class="text-gray-700 font-bold text-base font-pop truncate">${name}</span>
                </div>
            `;

            // æ”¹ç”¨ appendChild å°‡æ–°ä¸­çè€…åŠ åœ¨æœ€å¾Œé¢ (æ¸…å–®åº•éƒ¨)
            listEl.appendChild(div);
            
            // è‡ªå‹•æ²å‹•åˆ°æœ€åº•éƒ¨
            listEl.scrollTop = listEl.scrollHeight;
        }

        function updateWinnersList() {
            const listEl = document.getElementById('winners-list');
            listEl.innerHTML = '';
            
            checkGridColumns();

            let index = 1;
            const winnersArr = Array.from(pastWinners);
            
            winnersArr.forEach((name) => {
                const div = document.createElement('div');
                div.className = `bg-gray-50 p-2 rounded-lg border border-gray-100 flex justify-between items-center shadow-sm`;
                div.innerHTML = `
                     <div class="flex items-center gap-2 overflow-hidden w-full">
                        <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-xs shrink-0">
                            ${index++}
                        </div>
                        <span class="text-gray-600 font-bold text-base font-pop truncate">${name}</span>
                    </div>
                `;
                // æ”¹ç”¨ appendChild ä¿æŒé †åº (1è™Ÿåœ¨æœ€ä¸Šé¢ï¼Œæ–°è™Ÿç¢¼åœ¨ä¸‹é¢)
                listEl.appendChild(div);
            });
        }

        function removeHighlight() {
            const cards = document.querySelectorAll('.new-winner-card');
            cards.forEach(card => {
                card.classList.remove('new-winner-card');
                card.classList.add('bg-gray-50', 'border-gray-100');
            });
        }

        function resetDisplay() {
            isRolling = false;
            document.getElementById('display-area').innerHTML = `
                <div class="text-gray-400 text-xl font-bold font-pop">
                    æº–å‚™ä¸­
                </div>
            `;
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('drawing-status').style.opacity = '0';
        }

        function updateStatus(type, msg) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            text.innerText = msg;
            
            dot.className = "w-2 h-2 rounded-full";
            if (type === 'ok') dot.classList.add("bg-green-400");
            else if (type === 'error') dot.classList.add("bg-red-500");
            else dot.classList.add("bg-yellow-400");
        }
    </script>
</body>
</html>
